const $=e=>document.getElementById(e),CFG={types:["PHOTO","PLAN","MEET","REGISTER","BORING","SURVEY","DRAWING","SPEC","OTHRS"],names:["写真","計画","打合","台帳","調査","測量","図面","仕様","その他"],icons:["📷","📋","📝","📊","🔍","📐","📐","📖","📁"],patterns:[/\.(jpe?g|png|gif)$/i,/\.(pdf|docx?|xlsx?)$/i,/\.(pdf|docx?)$/i,/\.(pdf|xlsx?|csv)$/i,/\.(pdf|xlsx?)$/i,/\.(pdf|dwg|dxf)$/i,/\.(dwg|dxf|pdf)$/i,/\.(pdf|docx?)$/i,/\.(pdf|docx?|xlsx?|dwg|dxf)$/i],spec:{PHOTO:{s:"写真情報",f:"写真ファイル名",j:"",fields:{title:"写真タイトル",date:"撮影年月日",serial:"シリアル番号",media:"メディア番号",category:"写真-大分類",division:"写真区分",representative:"代表写真",frequency:"提出頻度写真"}},PLAN:{s:"施工計画書情報",f:"施工計画書オリジナルファイル名",j:"施工計画書オリジナルファイル日本語名",fields:{title:"施工計画書名称",date:"作成年月日",serial:"シリアル番号"}},MEET:{s:"打合せ簿情報",f:"打合せ簿オリジナルファイル名",j:"打合せ簿オリジナルファイル日本語名",fields:{title:"打合せ簿名称",date:"発行日付",serial:"シリアル番号"}},REGISTER:{s:"台帳情報",f:"台帳オリジナルファイル名",j:"台帳オリジナルファイル日本語名",fields:{title:"台帳名",date:"作成年月日",serial:"シリアル番号"}},BORING:{s:"地質調査情報",f:"地質調査オリジナルファイル名",j:"地質調査オリジナルファイル日本語名",fields:{title:"調査名",date:"調査年月日",serial:"シリアル番号"}},SURVEY:{s:"測量情報",f:"測量オリジナルファイル名",j:"測量オリジナルファイル日本語名",fields:{title:"測量名",date:"測量年月日",serial:"シリアル番号"}},DRAWING:{s:"図面情報",f:"図面オリジナルファイル名",j:"図面オリジナルファイル日本語名",fields:{title:"図面名",date:"作成年月日",serial:"シリアル番号"}},SPEC:{s:"仕様書情報",f:"仕様書オリジナルファイル名",j:"仕様書オリジナルファイル日本語名",fields:{title:"仕様書名",date:"作成年月日",serial:"シリアル番号"}},OTHRS:{s:"その他資料情報",f:"オリジナルファイル名",j:"オリジナルファイル日本語名",fields:{title:"資料名",date:"",serial:"シリアル番号"}}}};class XMLViewer{constructor(){this.M=new Map,this.X=new Map,this.U=new Map,this.F=new Map,this.P=[],this.I=0,this.R=null,this.E=new Set,this.photoData=new Map,this.init()}init(){const e=$("u"),t=$("i");["dragenter","dragover","dragleave","drop"].forEach((t,s)=>e.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),e.classList[s<2?"add":"remove"]("d")})),e.addEventListener("drop",e=>this.handleFiles([...e.dataTransfer.files])),t.addEventListener("change",e=>this.handleFiles([...e.target.files])),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.closeModal(),$("mo").classList.contains("sh")&&("ArrowLeft"===e.key&&this.prevPhoto(),"ArrowRight"===e.key&&this.nextPhoto())})}async handleFiles(e){if(e.length)try{this.progress(0,"収集"),this.clear();const t=[];e.forEach(e=>{const s=(e.webkitRelativePath||e.name).toUpperCase();if(this.M.set(s,e),s.endsWith(".XML"))if(s.includes("INDEX_C.XML"))t.unshift({file:e,type:"INDEX",path:s});else if(s.includes("OTHRS.XML"))t.push({file:e,type:"OTHRS",path:s});else{const i=CFG.types.find(e=>s.includes(e+"/"));i&&t.push({file:e,type:i,path:s})}}),this.progress(25,"解析"),await Promise.all(t.map(({file:e,type:t})=>this.readXML(e,t))),this.progress(60,"分類"),this.categorize(),this.progress(85,"構築"),this.buildTree(),this.hideProgress(),$("u").style.display="none",$("t").style.display="block",$("hs").textContent=`${this.F.size}分類、${this.M.size}ファイル`,this.updateProjectHeader()}catch(e){this.hideProgress(),this.error("エラー："+e.message)}}async readXML(e,t){try{if("INDEX"===t)return void await this.readIndexXML(e);if("OTHRS"===t)return void await this.readOthrsXML(e);const s=CFG.spec[t];if(!s)return;let i=await this.readText(e,"UTF-8");(i.includes("�")||!/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(i)||/encoding=["'](?:shift[-_]?jis|sjis|windows-31j)/i.test(i))&&(i=await this.readText(e,"Shift_JIS"));const a=(new DOMParser).parseFromString(i,"text/xml");if(a.querySelector("parsererror"))return;a.querySelectorAll(s.s).forEach(e=>{const i=e.querySelectorAll("オリジナルファイル情報");if(i.length>0)i.forEach(i=>{const a=this.getTag(i,s.f),o=s.j?this.getTag(i,s.j):null;a&&this.processXMLItem(e,a,t,s,o)});else{const i=this.getTag(e,s.f);i&&this.processXMLItem(e,i,t,s)}})}catch(t){console.warn("XML解析エラー:",e.name,t)}}async readOthrsXML(e){try{let t=await this.readText(e,"UTF-8");(t.includes("�")||!/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(t)||/encoding=["'](?:shift[-_]?jis|sjis|windows-31j)/i.test(t))&&(t=await this.readText(e,"Shift_JIS"));const s=(new DOMParser).parseFromString(t,"text/xml");if(s.querySelector("parsererror"))return;s.querySelectorAll("サブフォルダ情報").forEach(e=>{const t=this.getTag(e,"その他サブフォルダ日本語名");e.querySelectorAll("その他資料情報").forEach(e=>{const s=e.querySelector("オリジナルファイル情報");if(s){const i=this.getTag(s,"オリジナルファイル名"),a=this.getTag(s,"オリジナルファイル日本語名"),o=this.getTag(e,"資料名"),r=this.getTag(s,"シリアル番号");if(i){const e={filename:i,type:"OTHRS",title:o||t,serial:r,japaneseName:a,folder:t};[i,i.toUpperCase(),i.toLowerCase()].forEach(t=>{this.X.has(t)||this.X.set(t,e)})}}})})}catch(e){console.warn("OTHRS.XML解析エラー:",e)}}async readIndexXML(e){try{let t=await this.readText(e,"UTF-8");(t.includes("�")||!/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(t)||/encoding=["'](?:shift[-_]?jis|sjis|windows-31j)/i.test(t))&&(t=await this.readText(e,"Shift_JIS"));const s=(new DOMParser).parseFromString(t,"text/xml");if(s.querySelector("parsererror"))return;this.R={name:this.getTag(s,"工事件名"),type:this.getTag(s,"工種-工法形式"),content:this.getTag(s,"工事内容"),startDate:this.formatDate(this.getTag(s,"工期開始日")),endDate:this.formatDate(this.getTag(s,"工期終了日")),contractor:this.getTag(s,"請負業者名")}}catch(e){console.warn("INDEX_C.XML解析エラー:",e)}}formatDate(e){if(!e)return"";const t=e.match(/(\d{4})(\d{2})(\d{2})/);return t?`${t[1]}/${t[2]}/${t[3]}`:e}processXMLItem(e,t,s,i,a){if(!t)return;const o={filename:t,type:s};a&&(o.japaneseName=a),Object.entries(i.fields).forEach(([t,s])=>{const i=this.getTag(e,s);i&&(o[t]="代表写真"===s||"提出頻度写真"===s?"1"===i:i)}),[t,t.toUpperCase(),t.toLowerCase()].forEach(e=>{this.X.has(e)||this.X.set(e,o)})}readText(e,t="UTF-8"){return new Promise((s,i)=>{const a=new FileReader;a.onload=e=>s(e.target.result),a.onerror=i,a.readAsText(e,t)})}getTag(e,t){const s=e?.querySelector(t);return s?s.textContent.trim():""}categorize(){CFG.types.forEach((e,t)=>{const s=this.filterFiles(e,CFG.patterns[t]);s.length>0&&("PHOTO"===e?this.categorizePhotos(s):"OTHRS"===e?this.categorizeOthrs(s):this.categorizeNonPhoto(e,s))})}filterFiles(e,t){const s=[];for(let[i,a]of this.M)if((i.includes(e+"/")||i.includes(e))&&!i.endsWith(".XML")&&!i.endsWith(".DTD")&&t.test(i)){const e=i.split("/").pop();s.push({name:e,file:a,path:i,ext:e.split(".").pop().toLowerCase()})}return s}categorizePhotos(e){const t=new Map;e.forEach(e=>{const s=e.name,i=this.X.get(s)||this.X.get(s.toUpperCase())||this.X.get(s.toLowerCase())||{category:"未分類",division:"その他",title:s,filename:s},a=i.category||"未分類",o=i.division||"その他",r=i.title||s;t.has(a)||t.set(a,new Map),t.get(a).has(o)||t.get(a).set(o,new Map),t.get(a).get(o).has(r)||t.get(a).get(o).set(r,[]),t.get(a).get(o).get(r).push({...e,info:i}),this.photoData.set(`${a}|${o}`,{category:a,division:o,files:t.get(a).get(o)}),this.photoData.set(`${a}|${o}|${r}`,{category:a,division:o,title:r,files:t.get(a).get(o).get(r)})}),t.forEach((e,t)=>this.F.set(`PHOTO_${t}`,{key:`PHOTO_${t}`,name:t,folders:e,isPhoto:!0}))}categorizeOthrs(e){const t=new Map;e.forEach(e=>{const s=this.X.get(e.name)||this.X.get(e.name.toUpperCase())||this.X.get(e.name.toLowerCase());if(s){e.info=s;const i=s.folder||"その他";t.has(i)||t.set(i,[]),t.get(i).push(e)}}),t.forEach((e,t)=>{this.F.set(`OTHRS_${t}`,{key:`OTHRS_${t}`,name:t,files:e,baseType:"OTHRS"})})}categorizeNonPhoto(e,t){t.forEach(e=>{const t=this.X.get(e.name)||this.X.get(e.name.toUpperCase())||this.X.get(e.name.toLowerCase());t&&(e.info=t)}),this.F.set(e,{key:e,name:CFG.names[CFG.types.indexOf(e)],files:t,baseType:e})}buildTree(){const e=new Map;this.F.forEach((t,s)=>{const i=s.startsWith("PHOTO_")?"PHOTO":s.startsWith("OTHRS_")?"OTHRS":t.baseType||s;e.has(i)||e.set(i,{name:CFG.names[CFG.types.indexOf(i)]||i,folders:[]}),e.get(i).folders.push({key:s,folder:t})});let t="";e.forEach((e,s)=>{t+=`<div class="fg"><div class="ft">${e.name}</div>`,"PHOTO"===s?e.folders.forEach(({folder:e})=>{const s=e.key.split("_")[1];t+=`<div class="f" onclick="v.showFolder('${e.key}',this)"><div class="fi"><span class="fn">${e.name}</span></div><span class="fc">${this.getTotalFiles(e.folders)}</span></div>`,e.folders.forEach((e,i)=>{const a=`${s}|${i}`;t+=`<div class="f sub" onclick="v.toggleDivision('${a}',this)" style="margin-left:20px"><div class="fi"><span class="fn">${i}</span></div><span class="fc">${this.getTotalFiles(e)}</span></div>`,e.forEach((e,s)=>{t+=`<div class="f title" onclick="v.showFiles('${a}|${s}',this)" style="margin-left:40px;display:none" data-division="${a}"><div class="fi"><span class="fn">${s}</span></div><span class="fc">${e.length}</span></div>`})})}):e.folders.forEach(({key:e,folder:s})=>t+=`<div class="f" onclick="v.showFolder('${e}',this)"><div class="fi"><span class="fn">${s.name}</span></div><span class="fc">${s.files.length}</span></div>`),t+="</div>"}),$("t").innerHTML=t}getTotalFiles(e){return e instanceof Map?Array.from(e.values()).reduce((e,t)=>e+(Array.isArray(t)?t.length:this.getTotalFiles(t)),0):e.length||0}toggleDivision(e,t){const s=this.E.has(e);document.querySelectorAll(".f.ac").forEach(e=>e.classList.remove("ac")),s?(this.E.delete(e),document.querySelectorAll(`[data-division="${e}"]`).forEach(e=>e.style.display="none")):(this.E.add(e),document.querySelectorAll(`[data-division="${e}"]`).forEach(e=>e.style.display="block"),t.classList.add("ac"))}showFiles(e,t){document.querySelectorAll(".f.ac").forEach(e=>e.classList.remove("ac")),t.classList.add("ac");const s=this.photoData.get(e);if(!s)return;const i=s.files;$("h2").textContent=`${s.title} (${i.length})`,this.P=i;let a='<div class="pg">';i.forEach((e,t)=>{const s=this.getURL(e.file);a+=`<div class="pi" onclick="v.openPhoto(${t})"><img class="pt" src="${s}" alt="${e.info.title}" loading="lazy"><div class="pf"><div class="pn">${e.info.title}</div><div class="pd">${e.info.date||""}</div></div></div>`}),a+="</div>",$("g").innerHTML=a}showFolder(e,t){document.querySelectorAll(".f.ac").forEach(e=>e.classList.remove("ac")),t.classList.add("ac");const s=this.F.get(e);if(s)if(s.isPhoto){const e=[];s.folders.forEach(t=>t.forEach(t=>t.forEach(t=>e.push(t)))),$("h2").textContent=`${s.name} (${e.length})`,this.P=e;let t='<div class="pg">';e.forEach((e,s)=>{const i=this.getURL(e.file);t+=`<div class="pi" onclick="v.openPhoto(${s})"><img class="pt" src="${i}" alt="${e.info.title}" loading="lazy"><div class="pf"><div class="pn">${e.info.title}</div><div class="pd">${e.info.date||""}</div></div></div>`}),t+="</div>",$("g").innerHTML=t}else{$("h2").textContent=`${s.name} (${s.files.length})`;const e=new Map;s.files.forEach(t=>{const s=t.info||{},i=s.title||"未分類";e.has(i)||e.set(i,{title:i,date:s.date||"",files:[]}),e.get(i).files.push(t)});const t=Array.from(e.values()).sort((e,t)=>e.title.localeCompare(t.title));let i='<div class="tb"><table class="tbl"><thead><tr><th>日付</th><th>タイトル</th><th>ファイル</th></tr></thead><tbody>';t.forEach(e=>{i+=`<tr><td>${e.date}</td><td>${e.title}</td><td>`,e.files.forEach((e,t)=>{const s=e.info?.japaneseName||e.name;t>0&&(i+="<br>"),i+=`<span class="fl" onclick="v.openFile('${e.path}')">${s}</span>`}),i+="</td></tr>"}),i+="</tbody></table></div>",$("g").innerHTML=i}}updateProjectHeader(){if(!this.R)return;const{name:e,type:t,content:s,startDate:i,endDate:a,contractor:o}=this.R,r=[];if(e&&r.push(e),t&&r.push(t),s&&r.push(s.replace(/　/g,"")),(i||a)&&r.push((i||"")+(i&&a?"～":"")+(a||"")),o&&r.push(o),r.length){let e=$("project-info");e||(e=document.createElement("div"),e.id="project-info",$("h").appendChild(e)),e.innerHTML=r.join("<br>")}}getURL(e){return this.U.has(e)||this.U.set(e,URL.createObjectURL(e)),this.U.get(e)}openPhoto(e){if(e<0||e>=this.P.length)return;this.I=e;const t=this.P[e],s=t.info;$("mi").src=this.getURL(t.file);const i=$("mo"),a=i.querySelector(".mc");a.classList.add("photo-modal");let o=`<div class="mt">${s.title}</div>`;s&&(o+=`<div class="ig"><div class="il">番号</div><div class="iv">${s.serial||"なし"}</div></div>\n             <div class="ig"><div class="il">ファイル名</div><div class="iv">${s.filename}</div></div>\n             <div class="ig"><div class="il">撮影日</div><div class="iv">${s.date||"不明"}</div></div>\n             <div class="ig"><div class="il">メディア</div><div class="iv">${s.media||"なし"}</div></div>`,s.representative&&(o+='<span class="ba rep">★ 代表</span>'),s.frequency&&(o+='<span class="ba freq">⚡ 頻度</span>'));let r=i.querySelector(".photo-info");r||(r=document.createElement("div"),r.className="photo-info",a.appendChild(r)),r.innerHTML=o;const n=document.querySelector(".mn"),[l,c]=n.children;l.disabled=e<=0,c.disabled=e>=this.P.length-1,i.classList.add("sh")}prevPhoto(){this.I>0&&this.openPhoto(this.I-1)}nextPhoto(){this.I<this.P.length-1&&this.openPhoto(this.I+1)}openFile(e){try{const t=this.M.get(e);if(!t)return void this.error("ファイル未検出");const s=this.getURL(t),i=window.open();i?i.location.href=s:this.error("ポップアップブロック")}catch(e){this.error("ファイルエラー")}}closeModal(e){if(e?.target.closest(".mc"))return;const t=$("mo");t.classList.remove("sh"),t.querySelector(".mc").classList.remove("photo-modal");const s=t.querySelector(".photo-info");s&&s.remove()}progress(e,t){$("p").style.display="block";const s=$("pb");s.style.width=e+"%",s.textContent=t}hideProgress(){$("p").style.display="none"}error(e){const t=document.createElement("div");t.className="al er",t.textContent=e,$("g").appendChild(t),setTimeout(()=>t.remove(),3e3)}clear(){this.U.forEach(e=>URL.revokeObjectURL(e)),this.M.clear(),this.X.clear(),this.F.clear(),this.U.clear(),this.P=[],this.I=0,this.R=null,this.E.clear(),this.photoData=new Map;const e=$("project-info");e&&e.remove()}reset(){this.clear(),$("t").innerHTML="",$("t").style.display="none",$("u").style.display="block",$("g").innerHTML='<div class="em">選択でファイル表示</div>',$("h2").textContent="カテゴリ選択",$("i").value="",this.hideProgress(),$("hs").textContent="準備完了"}}document.addEventListener("DOMContentLoaded",()=>window.v=new XMLViewer);