name: Claude XML Viewer Optimizer
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    paths: ['index.html', '*.css', '*.js']
env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  MAX_DAYS: 30
  TARGET_REPO: 1tokan/xmlviewerfile
  TEST_FOLDER: CALS_EC
jobs:
  optimize:
    runs-on: ubuntu-latest
    timeout-minutes: 14
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - name: Time Guard
      run: |
        S=$(git log --format=%ct -n 1 -- .github/workflows/auto_optimize_claude.yml 2>/dev/null || echo $(date +%s))
        [ $(( ($(date +%s) - S) / 86400 )) -gt $MAX_DAYS ] && exit 1 || echo "âœ… Time OK"
    - name: Setup
      run: |
        npm init -y --type=module
        npm i axios cheerio fs-extra
    - name: Generate Optimizer
      run: |
        cat > opt.js << 'EOF'
        import axios from 'axios';
        import * as cheerio from 'cheerio';
        import fs from 'fs-extra';
        import path from 'path';
        
        const API='https://api.anthropic.com/v1/messages',MODEL='claude-3-5-sonnet-20241022',MAX_TOKENS=8000,TEMP=0.1,RETRIES=3,TIMEOUT=25000;
        const SYSTEM=`XML Vieweræœ€é©åŒ–å°‚é–€å®¶ã¨ã—ã¦ã€HTML/CSS/JSæ§‹é€ ã‚’æ®µéšçš„ã«åˆ†æãƒ»è¨ºæ–­ãƒ»æœ€é©åŒ–ã—ã¾ã™ã€‚å‡¦ç†é€Ÿåº¦ãƒ»ä»•æ§˜å®Œå…¨ç¶²ç¾…ãƒ»æ–‡å­—æ•°æœ€å°åŒ–ã‚’é‡è¦–ã—ã€å•é¡Œç‚¹ã®ã¿ã‚’ç‰¹å®šãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`;
        
        class ClaudeOpt {
          constructor() {
            this.key = process.env.ANTHROPIC_API_KEY;
            this.log = [];
            this.processed = new Set();
            this.outDir = 'optimized';
            this.baseUrl = 'https://1tokan.github.io/xmlviewerfile';
            this.testUrl = 'https://1tokan.github.io/CALS_EC';
          }
        
          async claude(prompt, ctx = '') {
            const full = `${ctx}\n\n${prompt}`;
            for (let i = 0; i < RETRIES; i++) {
              try {
                const res = await axios.post(API, {
                  model: MODEL,
                  max_tokens: MAX_TOKENS,
                  temperature: TEMP,
                  system: SYSTEM,
                  messages: [{ role: 'user', content: full }]
                }, {
                  headers: {
                    'Authorization': `Bearer ${this.key}`,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                  },
                  timeout: TIMEOUT
                });
                return res.data.content[0].text;
              } catch (e) {
                console.log(`ğŸ”„ Retry ${i + 1}/${RETRIES}: ${e.message}`);
                if (i === RETRIES - 1) throw e;
                await new Promise(r => setTimeout(r, 1000 * (i + 1)));
              }
            }
          }
        
          async analyze(file) {
            const start = Date.now();
            const content = await fs.readFile(file, 'utf8');
            const ext = path.extname(file);
            
            console.log(`ğŸ“‹ åˆ†æ: ${file}`);
            
            const prompt = `
        ## ğŸ” XML Viewerè¨ºæ–­ãƒ•ã‚§ãƒ¼ã‚º
        
        **å¯¾è±¡:** ${file}
        **æ§‹é€ :** HTML/CSS/JSçµ±åˆå‹XMLãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼
        **ç”¨é€”:** ${this.testUrl}ã®XMLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿è¡¨ç¤º
        
        \`\`\`${ext.slice(1)}
        ${content}
        \`\`\`
        
        **è¨ºæ–­è¦³ç‚¹:**
        1. ğŸš¨ è‡´å‘½çš„å•é¡Œ: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã€ç„¡é™ãƒ«ãƒ¼ãƒ—
        2. âš¡ é€Ÿåº¦å•é¡Œ: DOMæ“ä½œã€å†æç”»ã€é‡ã„ãƒ«ãƒ¼ãƒ—ã€éåŠ¹ç‡ã‚»ãƒ¬ã‚¯ã‚¿
        3. ğŸ”„ å†—é•·æ€§: é‡è¤‡ã‚³ãƒ¼ãƒ‰ã€æœªä½¿ç”¨å¤‰æ•°/é–¢æ•°ã€ç„¡é§„ãªå‡¦ç†
        4. ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼å‡¦ç†: XMLãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—å¯¾å¿œ
        5. ğŸ“ è¨­è¨ˆå•é¡Œ: è²¬å‹™æ··åœ¨ã€ä¿å®ˆæ€§ä½ä¸‹ã€å‘½åä¸çµ±ä¸€
        
        **å‡ºåŠ›å½¢å¼:**
        - å•é¡Œç®‡æ‰€: [Lè¡Œæ•°] å…·ä½“çš„å•é¡Œ
        - å½±éŸ¿åº¦: è‡´å‘½çš„/é‡è¦/è»½å¾®
        - ä¿®æ­£å¿…è¦: true/false
        - æ”¹å–„æ¡ˆ: å…·ä½“çš„ä¿®æ­£æ–¹æ³•
        
        **é‡è¦:** å•é¡Œãªã—éƒ¨åˆ†ã¯è§¦ã‚‰ãªã„ã€XMLãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã¯å¯¾è±¡å¤–
        `;
            
            const result = await this.claude(prompt);
            const time = Date.now() - start;
            
            this.log.push({
              phase: 'analyze',
              file,
              time,
              result,
              timestamp: new Date().toISOString()
            });
            
            return result;
          }
        
          async optimize(file, analysis) {
            const start = Date.now();
            const content = await fs.readFile(file, 'utf8');
            const ext = path.extname(file);
            
            console.log(`âš¡ æœ€é©åŒ–: ${file}`);
            
            const prompt = `
        ## ğŸš€ æœ€é©åŒ–ãƒ•ã‚§ãƒ¼ã‚º
        
        **åˆ†æçµæœ:**
        ${analysis}
        
        **å…ƒã‚³ãƒ¼ãƒ‰:**
        \`\`\`${ext.slice(1)}
        ${content}
        \`\`\`
        
        **æœ€é©åŒ–è¦ä»¶:**
        - ğŸ¯ å‡¦ç†é€Ÿåº¦: DOMæ“ä½œæœ€å°åŒ–ã€åŠ¹ç‡çš„ã‚»ãƒ¬ã‚¯ã‚¿ã€å†æç”»æŠ‘åˆ¶
        - ğŸ“¦ ã‚³ãƒ¼ãƒ‰åœ§ç¸®: å†—é•·å‰Šé™¤ã€å¤‰æ•°çµ±åˆã€é–¢æ•°æœ€é©åŒ–
        - ğŸ”§ æ©Ÿèƒ½åˆ†å‰²: xmlParser.js, errorHandler.js, uiController.js
        - ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼å‡¦ç†: try-catchè¿½åŠ ã€XMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
        - ğŸ“ ä¿å®ˆæ€§: å‘½åçµ±ä¸€ã€ã‚³ãƒ¡ãƒ³ãƒˆæœ€é©åŒ–ã€è²¬å‹™åˆ†é›¢
        
        **å‡ºåŠ›:**
        1. æœ€é©åŒ–ã‚³ãƒ¼ãƒ‰å…¨æ–‡
        2. å¤‰æ›´ç‚¹è©³ç´°
        3. åœ§ç¸®ç‡
        4. é€Ÿåº¦æ”¹å–„è¦‹è¾¼ã¿
        
        **åˆ¶ç´„:** åˆ†æã§å•é¡Œãªã— = å¤‰æ›´ç¦æ­¢ã€ç´”ç²‹ãƒãƒ‹ãƒ©JSã€æ©Ÿèƒ½å˜ä½åˆ†å‰²
        `;
            
            const result = await this.claude(prompt);
            const time = Date.now() - start;
            
            this.log.push({
              phase: 'optimize',
              file,
              time,
              result,
              timestamp: new Date().toISOString()
            });
            
            return result;
          }
        
          extractCode(text) {
            const blocks = text.match(/```[\s\S]*?```/g);
            if (!blocks) return null;
            return blocks[0].replace(/```[\w]*\n/, '').replace(/```$/, '').trim();
          }
        
          async split(content, base) {
            const max = 49152; // 48KB
            if (content.length <= max) return [{ name: base, content }];
            
            const parts = [];
            const chunks = Math.ceil(content.length / max);
            
            for (let i = 0; i < chunks; i++) {
              const start = i * max;
              const end = Math.min(start + max, content.length);
              parts.push({
                name: `${base}_part${i + 1}of${chunks}`,
                content: `/* ğŸ¤– Claudeæœ€é©åŒ– Part ${i + 1}/${chunks} */\n${content.slice(start, end)}`
              });
            }
            return parts;
          }
        
          async validate(orig, opt) {
            console.log(`ğŸ” æ¤œè¨¼: ${orig} vs ${opt}`);
            
            const prompt = `
        ## ğŸ§ª å·®åˆ†è©•ä¾¡ãƒ»æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º
        
        **æ¯”è¼ƒå¯¾è±¡:**
        - å…ƒ: ${orig}
        - æœ€é©åŒ–å¾Œ: ${opt}
        
        **æ¤œè¨¼è¦³ç‚¹:**
        1. ğŸ¨ UI/UX: è¡¨ç¤ºå´©ã‚Œã€æ“ä½œæ€§å¤‰åŒ–
        2. âš¡ é€Ÿåº¦: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„åº¦
        3. ğŸ›¡ï¸ å®‰å®šæ€§: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿãƒªã‚¹ã‚¯
        4. ğŸ”„ æ©Ÿèƒ½æ€§: XMLèª­ã¿è¾¼ã¿ãƒ»è¡¨ç¤ºæ©Ÿèƒ½
        5. ğŸ“± äº’æ›æ€§: ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
        
        **åˆ¤å®šåŸºæº–:**
        - âœ… åˆæ ¼: UIæ­£å¸¸ + é€Ÿåº¦æ”¹å–„ + æ©Ÿèƒ½ç¶­æŒ
        - âŒ ä¸åˆæ ¼: UIå´©ã‚Œ or æ©Ÿèƒ½åŠ£åŒ– or ã‚¨ãƒ©ãƒ¼å¢—åŠ 
        
        **å‡ºåŠ›:** åˆæ ¼/ä¸åˆæ ¼ + ç†ç”± + ä¿®æ­£æ¡ˆï¼ˆä¸åˆæ ¼æ™‚ï¼‰
        `;
            
            const result = await this.claude(prompt);
            
            this.log.push({
              phase: 'validate',
              orig,
              opt,
              result,
              timestamp: new Date().toISOString()
            });
            
            return result.includes('âœ…') || result.includes('åˆæ ¼');
          }
        
          async process(file) {
            if (this.processed.has(file)) {
              console.log(`â­ï¸ Skip: ${file}`);
              return;
            }
            
            try {
              const analysis = await this.analyze(file);
              
              if (analysis.includes('ä¿®æ­£å¿…è¦: false') || analysis.includes('å•é¡Œãªã—')) {
                console.log(`âœ… æœ€é©åŒ–ä¸è¦: ${file}`);
                this.processed.add(file);
                return;
              }
              
              const optimized = await this.optimize(file, analysis);
              const code = this.extractCode(optimized);
              
              if (!code) {
                console.log(`âŒ æœ€é©åŒ–å¤±æ•—: ${file}`);
                return;
              }
              
              const base = path.basename(file, path.extname(file));
              const parts = await this.split(code, base);
              
              await fs.ensureDir(this.outDir);
              const outPath = path.join(this.outDir, path.basename(file));
              
              if (parts.length === 1) {
                await fs.writeFile(outPath, parts[0].content);
              } else {
                for (const part of parts) {
                  const partPath = path.join(this.outDir, `${part.name}${path.extname(file)}`);
                  await fs.writeFile(partPath, part.content);
                }
              }
              
              const valid = await this.validate(file, outPath);
              
              if (valid) {
                console.log(`âœ… å®Œäº†: ${file}`);
                this.processed.add(file);
              } else {
                console.log(`âŒ æ¤œè¨¼å¤±æ•—: ${file}`);
                await fs.remove(outPath);
              }
              
            } catch (e) {
              console.error(`âŒ Error: ${file}`, e.message);
              this.log.push({
                phase: 'error',
                file,
                error: e.message,
                timestamp: new Date().toISOString()
              });
            }
          }
        
          async run() {
            console.log('ğŸš€ Claude XML Viewer Optimizer v2.0');
            
            const files = ['index.html'];
            
            try {
              const all = await fs.readdir('.');
              files.push(
                ...all.filter(f => f.endsWith('.css')),
                ...all.filter(f => f.endsWith('.js') && f !== 'opt.js')
              );
            } catch (e) {
              console.error('File scan error:', e.message);
            }
            
            console.log(`ğŸ“ å¯¾è±¡: ${files.join(', ')}`);
            
            for (const file of files) {
              try {
                if (await fs.pathExists(file)) {
                  await this.process(file);
                }
              } catch (e) {
                console.error(`Process error: ${file}`, e.message);
              }
            }
            
            await this.report();
            console.log('ğŸ‰ æœ€é©åŒ–å®Œäº†');
          }
        
          async report() {
            const report = {
              timestamp: new Date().toISOString(),
              target: this.baseUrl,
              testFolder: this.testUrl,
              totalFiles: this.processed.size,
              processedFiles: Array.from(this.processed),
              optimizationLog: this.log,
              summary: {
                totalTime: this.log.reduce((s, l) => s + (l.time || 0), 0),
                successCount: this.log.filter(l => l.phase === 'validate' && l.result.includes('âœ…')).length,
                errorCount: this.log.filter(l => l.phase === 'error').length,
                compressionRate: this.log.filter(l => l.phase === 'optimize').length > 0 ? 'è¨ˆç®—ä¸­' : '0%'
              }
            };
            
            await fs.writeFile('optimization_report.json', JSON.stringify(report, null, 2));
            console.log('ğŸ“Š Report: optimization_report.json');
          }
        }
        
        new ClaudeOpt().run().catch(console.error);
        EOF
    - name: Execute Optimization
      run: |
        node opt.js
        echo "ğŸ”„ æœ€é©åŒ–å®Ÿè¡Œå®Œäº†"
    - name: Deploy Results
      run: |
        git config --local user.email "claude@optimizer.ai"
        git config --local user.name "Claude Optimizer"
        
        if [ -d "optimized" ] && [ -n "$(git status --porcelain optimized/)" ]; then
          git add optimized/ optimization_report.json
          
          COUNT=$(find optimized/ -type f | wc -l)
          SIZE=$(du -sh optimized/ | cut -f1)
          
          git commit -m "ğŸš€ Claudeæœ€é©åŒ–å®Ÿè¡Œ [$(date '+%m/%d %H:%M')]
          
          ğŸ“Š å‡¦ç†çµæœ:
          - æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«: ${COUNT}å€‹ (${SIZE})
          - å¯¾è±¡ã‚µã‚¤ãƒˆ: https://1tokan.github.io/xmlviewerfile
          - ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€: https://1tokan.github.io/CALS_EC
          - è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: optimization_report.json
          
          ğŸ¯ æœ€é©åŒ–è¦³ç‚¹: é€Ÿåº¦å‘ä¸Šãƒ»ã‚³ãƒ¼ãƒ‰åœ§ç¸®ãƒ»ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»ä¿å®ˆæ€§
          
          [skip ci]"
          
          git push
          echo "âœ… æœ€é©åŒ–çµæœãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
        else
          echo "â„¹ï¸ æœ€é©åŒ–å¯¾è±¡ãªã—"
        fi
    - name: Status Report
      run: |
        if [ -f "optimization_report.json" ]; then
          echo "ğŸ“‹ æœ€é©åŒ–ã‚µãƒãƒªãƒ¼:"
          cat optimization_report.json | jq -r '.summary | to_entries[] | "\(.key): \(.value)"'
          echo ""
          echo "ğŸ“ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«:"
          cat optimization_report.json | jq -r '.processedFiles[]?' | head -10
        fi
        
        echo ""
        echo "ğŸŒ ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ:"
        echo "- ãƒ¡ã‚¤ãƒ³: https://1tokan.github.io/xmlviewerfile"
        echo "- æœ€é©åŒ–ç‰ˆ: https://1tokan.github.io/optimized"
        echo "- ãƒ†ã‚¹ãƒˆç”¨XML: https://1tokan.github.io/CALS_EC"
    - name: Cleanup
      run: |
        find optimized/ -type f -mtime +7 -delete 2>/dev/null || true
        find optimized/ -type d -empty -delete 2>/dev/null || true
        echo "ğŸ§¹ å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†"
