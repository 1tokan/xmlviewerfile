name: Claude XML Viewer Optimizer
on:
  schedule:
    - cron: '*/15 * * * *'  # 15åˆ†é–“éš”å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      phase:
        description: 'å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'diagnose'
          - 'optimize'
          - 'validate'
      continue_from:
        description: 'ç¶™ç¶šãƒã‚¤ãƒ³ãƒˆ'
        required: false
        default: ''

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  TARGET_REPO: '1tokan/xmlviewerfile'
  SOURCE_URL: 'https://1tokan.github.io/xmlviewerfile'
  OUTPUT_DIR: 'optimized'
  MAX_EXECUTION_DAYS: 30

jobs:
  claude-optimizer:
    runs-on: ubuntu-latest
    timeout-minutes: 14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm i -g @anthropic-ai/sdk jsdom prettier
        cat > package.json << 'EOF'
        {"type":"module","dependencies":{"@anthropic-ai/sdk":"^0.25.0","jsdom":"^22.1.0","prettier":"^3.0.0"}}
        EOF
        npm i
    
    - name: Check execution window
      id: check-window
      run: |
        start_date=$(date -d "$(git log --reverse --format="%ai" | head -1)" +%s)
        current_date=$(date +%s)
        days_diff=$(( (current_date - start_date) / 86400 ))
        echo "days_running=$days_diff" >> $GITHUB_OUTPUT
        echo "should_stop=$([[ $days_diff -gt $MAX_EXECUTION_DAYS ]] && echo true || echo false)" >> $GITHUB_OUTPUT
    
    - name: Create optimizer script
      run: |
        cat > optimizer.mjs << 'EOF'
        import Anthropic from '@anthropic-ai/sdk';
        import { JSDOM } from 'jsdom';
        import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
        import { dirname, join } from 'path';
        import { fileURLToPath } from 'url';
        
        const __dirname = dirname(fileURLToPath(import.meta.url));
        const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
        
        class ClaudeOptimizer {
          constructor() {
            this.baseUrl = process.env.SOURCE_URL;
            this.outputDir = process.env.OUTPUT_DIR;
            this.logFile = 'optimization_log.json';
            this.state = this.loadState();
            this.maxTokens = 4096;
          }
        
          loadState() {
            try {
              return existsSync(this.logFile) ? JSON.parse(readFileSync(this.logFile, 'utf8')) : {
                phase: 'diagnose',
                processed: [],
                issues: [],
                optimizations: [],
                iteration: 0,
                lastRun: null
              };
            } catch { return { phase: 'diagnose', processed: [], issues: [], optimizations: [], iteration: 0 }; }
          }
        
          saveState() {
            this.state.lastRun = Date.now();
            writeFileSync(this.logFile, JSON.stringify(this.state, null, 2));
          }
        
          async fetchContent(url) {
            try {
              const response = await fetch(url);
              return response.ok ? await response.text() : null;
            } catch { return null; }
          }
        
          async analyzeCode(content, filename) {
            const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã€æœ€é©åŒ–ãŒå¿…è¦ãªç®‡æ‰€ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ï¼š
        
        ãƒ•ã‚¡ã‚¤ãƒ«: ${filename}
        ã‚³ãƒ¼ãƒ‰:
        \`\`\`
        ${content.slice(0, 8000)}
        \`\`\`
        
        ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
        {
          "issues": [
            {
              "type": "performance|readability|maintainability|error_handling",
              "description": "å•é¡Œã®èª¬æ˜",
              "location": "è¡Œæ•°ã¾ãŸã¯é–¢æ•°å",
              "severity": "high|medium|low",
              "solution": "ä¿®æ­£æ–¹æ³•"
            }
          ],
          "metrics": {
            "codeSize": "æ–‡å­—æ•°",
            "complexity": "è¤‡é›‘åº¦(1-10)",
            "duplicateCode": "é‡è¤‡ã‚³ãƒ¼ãƒ‰æ•°"
          }
        }`;
        
            try {
              const response = await anthropic.messages.create({
                model: 'claude-3-sonnet-20240229',
                max_tokens: this.maxTokens,
                messages: [{ role: 'user', content: prompt }]
              });
              
              const result = JSON.parse(response.content[0].text);
              return result;
            } catch (error) {
              console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
              return { issues: [], metrics: { codeSize: content.length, complexity: 5, duplicateCode: 0 } };
            }
          }
        
          async optimizeCode(content, issues, filename) {
            const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„ï¼š
        
        ãƒ•ã‚¡ã‚¤ãƒ«: ${filename}
        å•é¡Œç‚¹: ${JSON.stringify(issues)}
        ã‚³ãƒ¼ãƒ‰:
        \`\`\`
        ${content.slice(0, 6000)}
        \`\`\`
        
        æœ€é©åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;
        
            try {
              const response = await anthropic.messages.create({
                model: 'claude-3-sonnet-20240229',
                max_tokens: this.maxTokens,
                messages: [{ role: 'user', content: prompt }]
              });
              
              return response.content[0].text.replace(/```[\s\S]*?```/g, (match) => 
                match.replace(/```(?:html|css|javascript|js)?\n?/, '').replace(/\n?```$/, '')
              );
            } catch (error) {
              console.error('æœ€é©åŒ–ã‚¨ãƒ©ãƒ¼:', error);
              return content;
            }
          }
        
          async diagnosePhase() {
            console.log('ğŸ” è¨ºæ–­ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹');
            const indexContent = await this.fetchContent(`${this.baseUrl}/index.html`);
            if (!indexContent) throw new Error('index.htmlå–å¾—å¤±æ•—');
        
            const dom = new JSDOM(indexContent);
            const doc = dom.window.document;
            
            // CSS/JSãƒ•ã‚¡ã‚¤ãƒ«æŠ½å‡º
            const cssFiles = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).map(link => link.href);
            const jsFiles = Array.from(doc.querySelectorAll('script[src]')).map(script => script.src);
            
            const filesToAnalyze = [
              { name: 'index.html', content: indexContent },
              ...await Promise.all(cssFiles.map(async url => ({
                name: url.split('/').pop(),
                content: await this.fetchContent(url.startsWith('http') ? url : `${this.baseUrl}/${url}`)
              }))),
              ...await Promise.all(jsFiles.map(async url => ({
                name: url.split('/').pop(),
                content: await this.fetchContent(url.startsWith('http') ? url : `${this.baseUrl}/${url}`)
              })))
            ];
        
            for (const file of filesToAnalyze.filter(f => f.content)) {
              if (this.state.processed.includes(file.name)) continue;
              
              console.log(`åˆ†æä¸­: ${file.name}`);
              const analysis = await this.analyzeCode(file.content, file.name);
              
              this.state.issues.push({
                file: file.name,
                content: file.content,
                analysis
              });
              
              this.state.processed.push(file.name);
              this.saveState();
            }
        
            this.state.phase = 'optimize';
            console.log(`âœ… è¨ºæ–­å®Œäº†: ${this.state.issues.length}ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ`);
          }
        
          async optimizePhase() {
            console.log('âš¡ æœ€é©åŒ–ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹');
            
            if (!existsSync(this.outputDir)) mkdirSync(this.outputDir, { recursive: true });
            
            for (const item of this.state.issues) {
              if (this.state.optimizations.some(o => o.file === item.file)) continue;
              
              const highIssues = item.analysis.issues.filter(i => i.severity === 'high');
              if (highIssues.length === 0) continue;
              
              console.log(`æœ€é©åŒ–ä¸­: ${item.file}`);
              const optimized = await this.optimizeCode(item.content, highIssues, item.file);
              
              const outputPath = join(this.outputDir, item.file);
              writeFileSync(outputPath, optimized);
              
              this.state.optimizations.push({
                file: item.file,
                original: item.content.length,
                optimized: optimized.length,
                reduction: Math.round((1 - optimized.length / item.content.length) * 100),
                timestamp: new Date().toISOString()
              });
              
              this.saveState();
            }
        
            this.state.phase = 'validate';
            console.log(`âœ… æœ€é©åŒ–å®Œäº†: ${this.state.optimizations.length}ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†`);
          }
        
          async validatePhase() {
            console.log('ğŸ” æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹');
            
            const report = {
              timestamp: new Date().toISOString(),
              totalFiles: this.state.optimizations.length,
              totalReduction: this.state.optimizations.reduce((sum, o) => sum + o.reduction, 0) / this.state.optimizations.length,
              issues: this.state.issues.length,
              optimizations: this.state.optimizations
            };
            
            writeFileSync(join(this.outputDir, 'optimization_report.json'), JSON.stringify(report, null, 2));
            
            console.log(`ğŸ“Š æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ:`);
            console.log(`- å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${report.totalFiles}`);
            console.log(`- å¹³å‡å‰Šæ¸›ç‡: ${report.totalReduction.toFixed(1)}%`);
            console.log(`- æ¤œå‡ºå•é¡Œæ•°: ${report.issues}`);
            
            this.state.phase = 'complete';
            this.state.iteration++;
            this.saveState();
          }
        
          async run(phase = 'all') {
            try {
              if (phase === 'all' || phase === 'diagnose') {
                if (this.state.phase === 'diagnose') await this.diagnosePhase();
              }
              
              if (phase === 'all' || phase === 'optimize') {
                if (this.state.phase === 'optimize') await this.optimizePhase();
              }
              
              if (phase === 'all' || phase === 'validate') {
                if (this.state.phase === 'validate') await this.validatePhase();
              }
              
              if (this.state.phase === 'complete') {
                console.log('ğŸ‰ æœ€é©åŒ–ã‚µã‚¤ã‚¯ãƒ«å®Œäº†');
                this.state.phase = 'diagnose';
                this.state.processed = [];
                this.saveState();
              }
            } catch (error) {
              console.error('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
              process.exit(1);
            }
          }
        }
        
        const optimizer = new ClaudeOptimizer();
        await optimizer.run(process.argv[2] || 'all');
        EOF
    
    - name: Execute optimization
      if: steps.check-window.outputs.should_stop == 'false'
      run: |
        node optimizer.mjs ${{ github.event.inputs.phase || 'all' }}
    
    - name: Commit and push optimizations
      if: steps.check-window.outputs.should_stop == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        
        if ! git diff --cached --quiet; then
          git commit -m "ğŸš€ Claudeæœ€é©åŒ– - Iteration ${{ github.run_number }}"
          git push
        else
          echo "å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
        fi
    
    - name: Create optimization summary
      if: steps.check-window.outputs.should_stop == 'false'
      run: |
        if [ -f optimization_log.json ]; then
          echo "## ğŸ¯ æœ€é©åŒ–ã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ—¥æ™‚: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ—¥æ•°: ${{ steps.check-window.outputs.days_running }}æ—¥" >> $GITHUB_STEP_SUMMARY
          
          if [ -f optimized/optimization_report.json ]; then
            echo "- æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(jq '.totalFiles' optimized/optimization_report.json)" >> $GITHUB_STEP_SUMMARY
            echo "- å¹³å‡å‰Šæ¸›ç‡: $(jq '.totalReduction' optimized/optimization_report.json)%" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º: $(jq -r '.phase' optimization_log.json)" >> $GITHUB_STEP_SUMMARY
          echo "- åå¾©å›æ•°: $(jq '.iteration' optimization_log.json)" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Stop execution after 30 days
      if: steps.check-window.outputs.should_stop == 'true'
      run: |
        echo "â° 30æ—¥é–“ã®å®Ÿè¡ŒæœŸé–“ãŒçµ‚äº†ã—ã¾ã—ãŸ"
        echo "æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™"
        
        if [ -f optimized/optimization_report.json ]; then
          echo "## ğŸ“Š æœ€çµ‚æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ç·å®Ÿè¡ŒæœŸé–“: ${{ steps.check-window.outputs.days_running }}æ—¥" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€é©åŒ–å®Œäº†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(jq '.totalFiles' optimized/optimization_report.json)" >> $GITHUB_STEP_SUMMARY
          echo "- å¹³å‡ã‚³ãƒ¼ãƒ‰å‰Šæ¸›ç‡: $(jq '.totalReduction' optimized/optimization_report.json)%" >> $GITHUB_STEP_SUMMARY
          
          # æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
          echo "### æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> $GITHUB_STEP_SUMMARY
          jq -r '.optimizations[] | "- \(.file): \(.reduction)% å‰Šæ¸›"' optimized/optimization_report.json >> $GITHUB_STEP_SUMMARY
        fi
        
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªå‹•åœæ­¢
        gh workflow disable "Claude XML Viewer Optimizer" --repo ${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
