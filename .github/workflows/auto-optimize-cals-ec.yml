name: XML Viewer Auto-Optimizer
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    paths: ['CALS_EC/**']

jobs:
  optimize:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm i -g terser html-minifier-terser
        mkdir -p optimized
        
    - name: Analyze & Split JS
      run: |
        cat > split.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        const srcPath = './CALS_EC/script.js';
        const outDir = './optimized';
        
        if (!fs.existsSync(srcPath)) {
          console.log('Source script not found');
          process.exit(0);
        }
        
        const content = fs.readFileSync(srcPath, 'utf8');
        const lines = content.split('\n');
        
        let modules = {
          'xml-parser.js': [],
          'table-renderer.js': [],
          'ui-controller.js': [],
          'utils.js': [],
          'main.js': []
        };
        
        let currentModule = 'main.js';
        
        lines.forEach(line => {
          if (line.includes('XMLParser') || line.includes('parseXML')) {
            currentModule = 'xml-parser.js';
          } else if (line.includes('Table') || line.includes('CALS') || line.includes('render')) {
            currentModule = 'table-renderer.js';
          } else if (line.includes('UI') || line.includes('click') || line.includes('event')) {
            currentModule = 'ui-controller.js';
          } else if (line.includes('function') && !line.includes('main')) {
            currentModule = 'utils.js';
          }
          
          modules[currentModule].push(line);
        });
        
        Object.entries(modules).forEach(([file, content]) => {
          if (content.length > 0) {
            fs.writeFileSync(path.join(outDir, file), content.join('\n'));
          }
        });
        
        console.log('JS modules split completed');
        EOF
        
        node split.js
        
    - name: Create Optimized XML Parser
      run: |
        cat > optimized/xml-parser.js << 'EOF'
        class XMLParser {
          constructor() {
            this.parser = new DOMParser();
            this.cache = new Map();
          }
          
          parse(xmlString) {
            const cacheKey = this.hash(xmlString);
            if (this.cache.has(cacheKey)) {
              return this.cache.get(cacheKey);
            }
            
            const doc = this.parser.parseFromString(xmlString, 'text/xml');
            this.cache.set(cacheKey, doc);
            return doc;
          }
          
          hash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
              hash = ((hash << 5) - hash + str.charCodeAt(i)) & 0xffffffff;
            }
            return hash;
          }
          
          getCALSTables(doc) {
            const tables = [];
            const tableNodes = doc.querySelectorAll('table, tgroup');
            
            tableNodes.forEach(node => {
              const table = this.parseCALSTable(node);
              if (table) tables.push(table);
            });
            
            return tables;
          }
          
          parseCALSTable(node) {
            const rows = node.querySelectorAll('row');
            const cols = node.getAttribute('cols') || this.getColCount(node);
            
            return {
              cols,
              rows: Array.from(rows).map(row => this.parseRow(row))
            };
          }
          
          parseRow(row) {
            const entries = row.querySelectorAll('entry');
            return Array.from(entries).map(entry => ({
              content: entry.textContent.trim(),
              colname: entry.getAttribute('colname'),
              namest: entry.getAttribute('namest'),
              nameend: entry.getAttribute('nameend'),
              morerows: entry.getAttribute('morerows')
            }));
          }
          
          getColCount(node) {
            const colspecs = node.querySelectorAll('colspec');
            return colspecs.length || 1;
          }
        }
        
        window.XMLParser = XMLParser;
        EOF
        
    - name: Create Optimized Table Renderer
      run: |
        cat > optimized/table-renderer.js << 'EOF'
        class TableRenderer {
          constructor() {
            this.fragment = document.createDocumentFragment();
          }
          
          render(tables, container) {
            if (!container) return;
            
            const frag = this.fragment.cloneNode(false);
            
            tables.forEach(table => {
              const tableEl = this.createTable(table);
              frag.appendChild(tableEl);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
          }
          
          createTable(table) {
            const tableEl = document.createElement('table');
            tableEl.className = 'cals-table';
            
            const tbody = document.createElement('tbody');
            
            table.rows.forEach(row => {
              const tr = document.createElement('tr');
              
              row.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell.content;
                
                if (cell.namest && cell.nameend) {
                  td.setAttribute('colspan', this.getColspan(cell.namest, cell.nameend));
                }
                
                if (cell.morerows) {
                  td.setAttribute('rowspan', parseInt(cell.morerows) + 1);
                }
                
                tr.appendChild(td);
              });
              
              tbody.appendChild(tr);
            });
            
            tableEl.appendChild(tbody);
            return tableEl;
          }
          
          getColspan(namest, nameend) {
            const start = parseInt(namest.match(/\d+/)?.[0] || 1);
            const end = parseInt(nameend.match(/\d+/)?.[0] || 1);
            return Math.max(1, end - start + 1);
          }
        }
        
        window.TableRenderer = TableRenderer;
        EOF
        
    - name: Create Optimized UI Controller
      run: |
        cat > optimized/ui-controller.js << 'EOF'
        class UIController {
          constructor() {
            this.parser = new XMLParser();
            this.renderer = new TableRenderer();
            this.fileInput = null;
            this.container = null;
            this.init();
          }
          
          init() {
            this.setupElements();
            this.bindEvents();
          }
          
          setupElements() {
            this.fileInput = document.getElementById('fileInput') || this.createElement('input', {
              type: 'file',
              accept: '.xml',
              id: 'fileInput'
            });
            
            this.container = document.getElementById('xmlContainer') || this.createElement('div', {
              id: 'xmlContainer',
              className: 'xml-container'
            });
            
            if (!document.getElementById('fileInput')) {
              document.body.appendChild(this.fileInput);
            }
            
            if (!document.getElementById('xmlContainer')) {
              document.body.appendChild(this.container);
            }
          }
          
          createElement(tag, attrs) {
            const el = document.createElement(tag);
            Object.entries(attrs).forEach(([key, value]) => {
              el[key] = value;
            });
            return el;
          }
          
          bindEvents() {
            this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
            
            document.addEventListener('dragover', (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'copy';
            });
            
            document.addEventListener('drop', (e) => {
              e.preventDefault();
              const files = e.dataTransfer.files;
              if (files.length > 0) {
                this.processFile(files[0]);
              }
            });
          }
          
          handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
              this.processFile(file);
            }
          }
          
          processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const xmlDoc = this.parser.parse(e.target.result);
                const tables = this.parser.getCALSTables(xmlDoc);
                this.renderer.render(tables, this.container);
              } catch (error) {
                this.showError(error.message);
              }
            };
            reader.readAsText(file);
          }
          
          showError(message) {
            this.container.innerHTML = `<div class="error">Error: ${message}</div>`;
          }
        }
        
        window.UIController = UIController;
        EOF
        
    - name: Create Optimized Utils
      run: |
        cat > optimized/utils.js << 'EOF'
        const Utils = {
          debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
              const later = () => {
                clearTimeout(timeout);
                func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
            };
          },
          
          throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function(...args) {
              if (!lastRan) {
                func(...args);
                lastRan = Date.now();
              } else {
                clearTimeout(lastFunc);
                lastFunc = setTimeout(() => {
                  if ((Date.now() - lastRan) >= limit) {
                    func(...args);
                    lastRan = Date.now();
                  }
                }, limit - (Date.now() - lastRan));
              }
            };
          },
          
          formatXML(xml) {
            const PADDING = ' '.repeat(2);
            const reg = /(>)(<)(\/*)/g;
            let formatted = xml.replace(reg, '$1\r\n$2$3');
            
            let pad = 0;
            return formatted.split('\r\n').map(line => {
              let indent = 0;
              if (line.match(/.+<\/\w[^>]*>$/)) {
                indent = 0;
              } else if (line.match(/^<\/\w/)) {
                if (pad !== 0) {
                  pad -= 1;
                }
              } else if (line.match(/^<\w[^>]*[^\/]>.*$/)) {
                indent = 1;
              } else {
                indent = 0;
              }
              
              const padding = PADDING.repeat(pad);
              pad += indent;
              
              return padding + line;
            }).join('\r\n');
          },
          
          validateXML(xmlString) {
            try {
              const parser = new DOMParser();
              const doc = parser.parseFromString(xmlString, 'text/xml');
              const parseError = doc.querySelector('parsererror');
              
              if (parseError) {
                throw new Error(parseError.textContent);
              }
              
              return { valid: true, error: null };
            } catch (error) {
              return { valid: false, error: error.message };
            }
          }
        };
        
        window.Utils = Utils;
        EOF
        
    - name: Create Optimized Main
      run: |
        cat > optimized/main.js << 'EOF'
        document.addEventListener('DOMContentLoaded', () => {
          const app = new UIController();
          console.log('XML Viewer initialized');
        });
        EOF
        
    - name: Create Optimized HTML
      run: |
        cat > optimized/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ja">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>XML Viewer - CALS EC</title>
          <style>
            *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:Arial,sans-serif;background:#f5f5f5}
            .container{max-width:1200px;margin:0 auto;padding:20px}
            .upload-area{border:2px dashed #ccc;padding:40px;text-align:center;margin:20px 0;background:#fff;border-radius:8px}
            .upload-area:hover{border-color:#007bff}
            .cals-table{width:100%;border-collapse:collapse;margin:20px 0;background:#fff}
            .cals-table td{border:1px solid #ddd;padding:8px;text-align:left}
            .cals-table tr:nth-child(even){background:#f9f9f9}
            .error{color:#d32f2f;background:#ffebee;padding:10px;border-radius:4px;margin:10px 0}
            .loading{text-align:center;padding:20px;color:#666}
            @media (max-width:768px){
              .container{padding:10px}
              .cals-table{font-size:14px}
              .cals-table td{padding:4px}
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>XML Viewer - CALS EC</h1>
            <div class="upload-area">
              <input type="file" id="fileInput" accept=".xml" style="display:none">
              <p>XMLファイルをドロップまたはクリックして選択</p>
            </div>
            <div id="xmlContainer"></div>
          </div>
          
          <script src="xml-parser.js"></script>
          <script src="table-renderer.js"></script>
          <script src="ui-controller.js"></script>
          <script src="utils.js"></script>
          <script src="main.js"></script>
        </body>
        </html>
        EOF
        
    - name: Minify Files
      run: |
        cd optimized
        for file in *.js; do
          terser "$file" --compress --mangle -o "$file.min"
          mv "$file.min" "$file"
        done
        
        html-minifier-terser --collapse-whitespace --remove-comments --minify-css --minify-js index.html -o index.html
        
    - name: Performance Test
      run: |
        cat > test-performance.js << 'EOF'
        const fs = require('fs');
        const { performance } = require('perf_hooks');
        
        const testXML = `<?xml version="1.0"?>
        <document>
          <table>
            <tgroup cols="3">
              <colspec colname="col1"/>
              <colspec colname="col2"/>
              <colspec colname="col3"/>
              <tbody>
                <row>
                  <entry>Cell 1</entry>
                  <entry>Cell 2</entry>
                  <entry>Cell 3</entry>
                </row>
              </tbody>
            </tgroup>
          </table>
        </document>`;
        
        const iterations = 1000;
        const start = performance.now();
        
        for (let i = 0; i < iterations; i++) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(testXML, 'text/xml');
          const tables = doc.querySelectorAll('table, tgroup');
        }
        
        const end = performance.now();
        const avgTime = (end - start) / iterations;
        
        console.log(`Average parse time: ${avgTime.toFixed(2)}ms`);
        
        const stats = {
          timestamp: new Date().toISOString(),
          averageParseTime: avgTime,
          iterations,
          fileSize: fs.statSync('./optimized/xml-parser.js').size
        };
        
        fs.writeFileSync('./optimized/performance-stats.json', JSON.stringify(stats, null, 2));
        EOF
        
        node test-performance.js
        
    - name: Create Archive
      run: |
        cd optimized
        tar -czf ../optimized-$(date +%Y%m%d-%H%M%S).tar.gz .
        
    - name: Commit Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add optimized/
          git commit -m "Auto-optimize XML viewer - $(date +%Y-%m-%d\ %H:%M:%S)"
          git push
        fi
        
    - name: Clean Old Artifacts
      run: |
        find . -name "optimized-*.tar.gz" -mtime +30 -delete
        
    - name: Summary
      run: |
        echo "## Optimization Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Files optimized**: $(ls -la optimized/ | wc -l) files" >> $GITHUB_STEP_SUMMARY
        echo "- **Total size**: $(du -sh optimized/ | cut -f1)" >> $GITHUB_STEP_SUMMARY
        
        if [ -f optimized/performance-stats.json ]; then
          echo "- **Performance**: $(cat optimized/performance-stats.json | jq -r '.averageParseTime')ms avg parse time" >> $GITHUB_STEP_SUMMARY
        fi