name: API Key Debug Test
on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug Level'
        required: false
        default: 'basic'
        type: choice
        options:
          - 'basic'
          - 'detailed'
          - 'full'

jobs:
  debug-api-keys:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Debug API Keys
      run: |
        echo "ðŸ” APIã‚­ãƒ¼ãƒ‡ãƒãƒƒã‚°é–‹å§‹"
        echo "é¸æŠžã•ã‚ŒãŸãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«: ${{ github.event.inputs.debug_level }}"
        echo ""
        
        # åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        echo "ðŸ“‹ åŸºæœ¬æƒ…å ±:"
        echo "- GitHub Repository: ${{ github.repository }}"
        echo "- GitHub Actor: ${{ github.actor }}"
        echo "- Event Type: ${{ github.event_name }}"
        echo ""
        
        # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
        echo "ðŸ”‘ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå­˜åœ¨ç¢ºèª:"
        
        # ANTHROPIC_API_KEY_GOTS_YAHOO
        if [ -n "${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}" ]; then
          echo "âœ… ANTHROPIC_API_KEY_GOTS_YAHOO: å­˜åœ¨"
          GOTS_KEY="${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}"
          key_len=${#GOTS_KEY}
          echo "   ðŸ“ é•·ã•: $key_lenæ–‡å­—"
          echo "   ðŸ”¤ é–‹å§‹: $(echo "$GOTS_KEY" | head -c 15)..."
        else
          echo "âŒ ANTHROPIC_API_KEY_GOTS_YAHOO: æœªè¨­å®š"
        fi
        
        # ANTHROPIC_API_KEY_NAOTO_G
        if [ -n "${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}" ]; then
          echo "âœ… ANTHROPIC_API_KEY_NAOTO_G: å­˜åœ¨"
          NAOTO_KEY="${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}"
          key_len=${#NAOTO_KEY}
          echo "   ðŸ“ é•·ã•: $key_lenæ–‡å­—"
          echo "   ðŸ”¤ é–‹å§‹: $(echo "$NAOTO_KEY" | head -c 15)..."
        else
          echo "âŒ ANTHROPIC_API_KEY_NAOTO_G: æœªè¨­å®š"
        fi
        
        echo ""
        
        # è©³ç´°ãƒ‡ãƒãƒƒã‚°
        if [ "${{ github.event.inputs.debug_level }}" != "basic" ]; then
          echo "ðŸ” è©³ç´°ãƒã‚§ãƒƒã‚¯é–‹å§‹"
          
          # APIã‚­ãƒ¼ã®å½¢å¼ç¢ºèª
          check_key_format() {
            local key_name=$1
            local key_value=$2
            
            echo "ðŸ”¤ $key_name å½¢å¼ãƒã‚§ãƒƒã‚¯:"
            
            if [ -z "$key_value" ]; then
              echo "   âŒ ç©ºæ–‡å­—ã¾ãŸã¯null"
              return 1
            fi
            
            # é•·ã•ãƒã‚§ãƒƒã‚¯
            key_len=${#key_value}
            echo "   ðŸ“ é•·ã•: $key_lenæ–‡å­—"
            
            # é–‹å§‹æ–‡å­—åˆ—ãƒã‚§ãƒƒã‚¯
            if [[ "$key_value" =~ ^sk-ant- ]]; then
              echo "   âœ… é–‹å§‹æ–‡å­—åˆ—: sk-ant-"
            else
              echo "   âŒ é–‹å§‹æ–‡å­—åˆ—: $(echo "$key_value" | head -c 10)... (sk-ant-ã§å§‹ã¾ã£ã¦ã„ã¾ã›ã‚“)"
            fi
            
            # æ–‡å­—ç¨®ãƒã‚§ãƒƒã‚¯
            if [[ "$key_value" =~ ^[a-zA-Z0-9_-]+$ ]]; then
              echo "   âœ… æ–‡å­—ç¨®: è‹±æ•°å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€ãƒã‚¤ãƒ•ãƒ³ã®ã¿"
            else
              echo "   âŒ æ–‡å­—ç¨®: ä¸æ­£ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
            fi
            
            # åŸºæœ¬çš„ãªé•·ã•ãƒã‚§ãƒƒã‚¯ï¼ˆAnthropic APIã‚­ãƒ¼ã¯é€šå¸¸100æ–‡å­—ç¨‹åº¦ï¼‰
            if [ "$key_len" -gt 50 ] && [ "$key_len" -lt 200 ]; then
              echo "   âœ… é•·ã•: é©åˆ‡ãªç¯„å›²å†…"
            else
              echo "   âš ï¸ é•·ã•: é€šå¸¸ã¨ç•°ãªã‚‹ (50-200æ–‡å­—ãŒä¸€èˆ¬çš„)"
            fi
            
            echo ""
          }
          
          # å„ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -n "${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}" ]; then
            check_key_format "ANTHROPIC_API_KEY_GOTS_YAHOO" "${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}"
          fi
          
          if [ -n "${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}" ]; then
            check_key_format "ANTHROPIC_API_KEY_NAOTO_G" "${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}"
          fi
        fi
        
        # ãƒ•ãƒ« ãƒ‡ãƒãƒƒã‚°ï¼ˆæŽ¥ç¶šãƒ†ã‚¹ãƒˆï¼‰
        if [ "${{ github.event.inputs.debug_level }}" == "full" ]; then
          echo "ðŸŒ æŽ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹"
          
          test_connection() {
            local key_name=$1
            local key_value=$2
            
            if [ -z "$key_value" ]; then
              echo "â­ï¸ $key_name: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰"
              return 1
            fi
            
            echo "ðŸ”„ $key_name æŽ¥ç¶šãƒ†ã‚¹ãƒˆä¸­..."
            
            # è»½é‡ãªãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            response=$(curl -s -w "%{http_code}" \
              -X POST "https://api.anthropic.com/v1/messages" \
              -H "Authorization: Bearer $key_value" \
              -H "Content-Type: application/json" \
              -H "anthropic-version: 2023-06-01" \
              -d '{
                "model": "claude-3-haiku-20240307",
                "max_tokens": 5,
                "messages": [{"role": "user", "content": "Hi"}]
              }' \
              --connect-timeout 15 \
              --max-time 30 \
              -o /tmp/test_$key_name.json)
            
            echo "   ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $response"
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’è¡¨ç¤º
            if [ -f "/tmp/test_$key_name.json" ]; then
              echo "   ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (æœ€åˆã®200æ–‡å­—):"
              cat /tmp/test_$key_name.json | head -c 200
              echo ""
            fi
            
            case $response in
              200)
                echo "   âœ… æˆåŠŸ: APIã‚­ãƒ¼ã¯æœ‰åŠ¹ã§ã™"
                return 0
                ;;
              401)
                echo "   âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™"
                return 1
                ;;
              403)
                echo "   âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦: æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
                return 1
                ;;
              429)
                echo "   âš ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ä¸€æ™‚çš„ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™"
                return 1
                ;;
              *)
                echo "   âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: HTTP $response"
                return 1
                ;;
            esac
          }
          
          # æŽ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          if [ -n "${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}" ]; then
            test_connection "ANTHROPIC_API_KEY_GOTS_YAHOO" "${{ secrets.ANTHROPIC_API_KEY_GOTS_YAHOO }}"
          fi
          
          if [ -n "${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}" ]; then
            test_connection "ANTHROPIC_API_KEY_NAOTO_G" "${{ secrets.ANTHROPIC_API_KEY_NAOTO_G }}"
          fi
        fi
        
        echo ""
        echo "ðŸŽ¯ æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
        echo "1. Anthropic Console (https://console.anthropic.com) ã§APIã‚­ãƒ¼ã‚’ç¢ºèª"
        echo "2. ã‚­ãƒ¼ã®ä½¿ç”¨é‡ã¨åˆ¶é™ã‚’ç¢ºèª"
        echo "3. æ–°ã—ã„APIã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦å†è¨­å®š"
        echo "4. GitHub Secretsã§æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
        echo ""
        echo "ðŸ“š å‚è€ƒè³‡æ–™:"
        echo "- Anthropic API Documentation: https://docs.anthropic.com/"
        echo "- GitHub Secretsè¨­å®š: Settings > Secrets and variables > Actions"
